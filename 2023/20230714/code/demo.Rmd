---
title: "Untitled"
output: html_document
date: "`r Sys.Date()`"
---
```{r}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
```

```{r}
library(tidyverse)
library(edgeR)
library(ggdist)
theme_set(theme_bw())
set.seed(20230714)
```

### $p$-value Histograms
```{r}
cols <- c("#F27A5E", "#15AEBF")

matnorm <- function(mu) {
  N <- nrow(mu)
  M <- ncol(mu)

  x <- matrix(nrow = N, ncol = M)
  for (i in seq_len(N)) {
    x[i, ] <- rnorm(M, mu[i, ])
  }
  
  x
}

simulate_pvalues <- function(N, M, signal = 0.25, nonnull_frac = 0.2) {
  mu <- matrix(0, N, M)
  disease_ix <- seq_len(N / 2)
  nonnull_ix <- seq_len(nonnull_frac * M)
  mu[disease_ix, nonnull_ix] <- signal
  x <- matnorm(mu)
  
  p_values <- list()
  for (j in seq_len(M)) {
    p_values[[j]] <- tibble(
      hypothesis = j,
      p_value = t.test(x[disease_ix, j], x[-disease_ix, j])$p.value
    )
  }
  
  p_values |>
    bind_rows() |>
    mutate(
      nonnull = ifelse(hypothesis %in% nonnull_ix, "nonnull", "null"),
      nonnull = factor(nonnull, levels = c("nonnull", "null"))
    )
}


plot_pval <- function(p_values, facet = FALSE) {
  p <- list()

  p[[1]] <- ggplot(p_values) +
    geom_histogram(aes(p_value, stat(density)), binwidth = 0.03) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0, 0.1, 0)) +
    labs(x = "p-value", y = "Density") +
    theme(
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      panel.border = element_blank()
    )
  
  p[[2]] <- ggplot(p_values) +
    geom_histogram(
      aes(p_value, stat(density), fill = nonnull), 
      position = "identity",
      alpha = 0.7,
      binwidth = 0.03
    ) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0, 0.1, 0)) +
    labs(x = "p-value", y = "Density") +
    scale_fill_manual(values = cols, guide = "none") +
    theme(
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      panel.border = element_blank()
    )
  
  if (facet) {
    p[[2]] <- p[[2]] + 
      facet_grid(nonnull ~ ., scales = "free_y")
  }

  p
}

simulate_pvalues(200, 1e4) |>
  plot_pval()
ggsave("../figure/histogram-1.svg")
simulate_pvalues(200, 1e4, nonnull_frac = 0.1) |>
  plot_pval()
ggsave("../figure/histogram-2.svg")
simulate_pvalues(200, 1e4, nonnull_frac = 0.1) |>
  plot_pval(facet = FALSE)
ggsave("../figure/histogram-3.svg")
```

### NB Miscalibration

```{r}
nb_matrix <- function(mu, N = 100, size = 1) {
  x <- matrix(0, N, length(mu))
  for (j in seq_along(mu)) {
    x[, j] <- rnbinom(N, size, mu = mu[j])
  }

  x
}
```

```{r}
M <- 1000
nonnull <- 200
mu0 <- rep(50, M)
mu1 <- mu0
mu1[1:nonnull] <- mu0[1:nonnull] * 1.6

x <- list(
   disease = nb_matrix(mu1),
   healthy = nb_matrix(mu0) 
  ) |>
  map(~ calcNormFactors(DGEList(t(.)))) |>
  map(~ as_tibble(t(cpm(., log = TRUE)))) |>
  bind_rows(.id = "state")
```

```{r}
x |>
  pivot_longer(-state, names_to = "hypothesis") |>
  mutate(hypothesis = as.integer(hypothesis)) |>
  filter(
    hypothesis %in% c(1:10, (nonnull + 1):(nonnull + 10))
  ) |>
  mutate(
    null = ifelse(hypothesis <= nonnull, "Nonnull", "Null"),
    #null = factor(null, levels = c("Nonnull", "Null"))
  ) |>
  ggplot() +
  stat_pointinterval(
    aes(as.factor(hypothesis), value, fill = state, col = state),
    alpha = 0.6, width = 2
  ) +
  facet_wrap(~ null, scale = "free_x", ncol = 1)
```


```{r}
p_values <- list()
ix <- seq_len(nrow(x) / 2)

for (j in seq(2, ncol(x))) {
  p_values[[j]] <- tibble(
    hypothesis = j - 1,
    p_value = t.test(x[ix, j], x[-ix, j])$p.value
  )
}

p_values <- bind_rows(p_values) |>
  mutate(nonnull = hypothesis %in% seq_len(nonnull))

# ggplot(p_values) +
#   geom_histogram(aes(p_value), binwidth = 0.025) +
#   scale_y_continuous(expand = c(0, 0, 0.1, 0))
# 
# ggsave("../figure/miscalibration_histogram_merged.png")

ggplot(p_values) +
  geom_histogram(
    aes(p_value, fill = nonnull),
    binwidth = 0.025
  ) +
  scale_y_continuous(expand = c(0, 0, 0.1, 0)) +
  scale_fill_manual(values = c("orange", "royalblue")) +
  facet_grid(nonnull ~ ., scales = "free_y")

ggsave("../figure/miscalibration_histogram.png")
```

<!-- ### Context -->

<!-- ```{r} -->
<!-- N <- c(100, 200) # the numbers of SNPs and histone markers, respectively -->
<!-- snps <- matrix(N[1], 0) -->

<!-- for (n in seq_len(N[1])) { -->
<!-- } -->
<!-- ``` -->





