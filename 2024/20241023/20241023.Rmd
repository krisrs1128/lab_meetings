---
title: "Managing Batch Effects in Biological Data"
author: "Kris Sankaran"
output:
  xaringan::moon_reader:
    css: ["default", "css/xaringan-themer.css"]
    lib_dir: libs
    self_contained: false
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: "16:9"
    seal: false
---

class: title

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
    Macros: {
      myred: ["{\\color{myred}{#1}}", 1],
      mygreen: ["{\\color{mygreen}{#1}}", 1]
    },
    loader: {load: ['[tex]/color']},
    tex: {packages: {'[+]': ['color']}}
  }
});
</script>


<style>
.myred {color: #B4575C;}
.mygreen {color: #5A8A80;}
</style>

```{r flair_color, echo=FALSE, warning = FALSE, message = FALSE}
library(xaringancolor)
setup_colors(
  myred = "#B4575C",
  mygreen = "#5A8A80"
)

library(flair)
myred <- "#B4575C"
mygreen <- "#5A8A80"
```


```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(MASS)
library(knitr)
library(RefManageR)
library(tidyverse)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, dpi = 200, fig.align = "center", fig.width = 6, fig.height = 3)

BibOptions(
  check.entries = FALSE,
  bib.style = "numeric",
  cite.style = "numeric",
  style = "markdown",
  hyperlink = FALSE,
  dashed = FALSE,
  max.names = 1
)
bib <- ReadBib("references.bib")
```

## Managing Batch Effects in Sequencing Data

<div id="subtitle">
Kris Sankaran <br/>
23 | October | 2024 <br/>
Lab: <a href="https://go.wisc.edu/pgb8nl">go.wisc.edu/pgb8nl</a> <br/>
</div>

<div id="subtitle_right">
BME 780: Methods in Quantitative Biology<br/>
Slides: <a href="https://go.wisc.edu/">go.wisc.edu/</a><br/>
</div>

<!-- 50 minute talk -->

---

### Learning Outcomes

By the end of this lecture, you will be able to:

1. **Imagine**: Evaluate whether batch effects might exist in your data.

1. **Derive**: Interpret algebraic expressions used to represent batch effect correction methods.

1. **Decide**: Navigate trade-offs between batch effect correction approaches.

1. **Check**: Implement diagnostics to ensure trustworthy outputs.

1. **Improve**: Explain the potential for replication and controls to improve batch effect correction methods

---

.center[
## Motivation
]

---

### Cancer Microbiome Controversy

1. In June 2024, the journal Nature retracted a paper the claimed distinct
microbiome signatures associated with different types of cancer. 

1. Competing labs suspected data analysis mistakes when they recognized unusual,
marine taxa among those that were most important.

1. After 3 rounds of argument and counter-argument, the paper was retracted.

---

### Cancer Microbiome Controversy

1. Most researchers now agree that the signature discussed in the original paper
was a technical artifact resulting from the use of supervised normalization, a
particular batch effect correction method.

1. Before we can understand the nuances of this story, we need to learn about
batch effects and the methods that have been designed to address them.

---

### Measurement vs. Reality

1. In the same way that a photo can be blurry or obscured by glare, the
measurements we obtain from sequencing can be obscured by technical factors.

1. Any data are only an imperfect snapshot of the true biological moment that
we're seeking to understand. 

.center[
    <img src="figures/kensington.jpg" width=900>
]

---

### Measurement vs. Reality

1. In the same way that a photo can be blurry or obscured by glare, the
measurements we obtain from sequencing can be obscured by technical factors.

1. Any data are only an imperfect snapshot of the true biological moment that
we're seeking to understand. 

.center[

]

---

### Sources of Technical Variation

There are many points at which technical variation arise.

.center[
<img src="figures/sources_of_variation.png" width=900/>
]

---

### Technical Variation $\to$ Batch Effects

1. Differences at any stage can lead to systematic differences between data
collected across experimental runs ("batches").

1. This is especially problematic for studies with large sample sizes or
multiple study sites. It may not be feasible to process all samples in exactly
the same way.

---

### Improving Discovery

1. Batch effects can mask real biological effects.

1. To discover more interesting patterns, we need to either remove these effects
or account for them in the later models.

(show the classic PCA picture from Leek)

---

### Improving Credibility

1. To dispute a scientific fact, a dissenter can always argue that the
conditions that led to its production are not generalizable.

1. If we can account for as much batch-to-batch variation as possible, we can
fortify ourselves against this line of attack.

(picture or quote from Latour re. induction)

---

## Correction Techniques

---

### General Strategies

1. Correct: Subtract the batch effects before all other analysis.
1. Account: Directly model batch-to-batch variation in the analysis.

|  | Pros | Cons |
|--|---|---|
| Correct | Generality. Can be reused easily. | Can introduce its own artifacts. |
| Account | Cohesion. Only one method needed for everything.  | Time consuming. Requires development for each context. |

We will review correction methods, since we don't want to restrict ourselves to
any application context.

---

### Correction Methods

Correction methods define:

1. A class of allowable transformations that can be used to remove the batch effects.

1. An objective function we can optimize to help us find the most plausible
transformation.

There are many ways to parameterize and optimize over transformations, and the
best choice can depend on specific properties of the data and experimental
design.

---

### Exemplar Methods

1. Two classic methods are ComBat (2007, 7.6K citations) and Harmony (2019, 4.8K
citations).

1. ComBat is based off a linear model, while Harmony uses nonlinear embedding
ideas.

1. Next week, we will discuss CellAnova (2023), which is a modern descendant
of these techniques.

---

### ComBat - Setting

(include the screenshot)

---

### ComBat - Model

---

### ComBat - Estimation

---

### Example: Harmony

---

### Objective Function

---

### Optimization

---

## Checking Your Work

---

### Challenges

Batch effect correction can introduce subtle problems of its own.

1. Biases in Testing
1. Incomplete removal
1. Is the data even alignable?

---

### Is it Hopeless?

(screenshot from biostars)

1. We shouldn't apply correction methods if we don't see any effects. But we
also shouldn't ignore them if they exist.

1. We just need to be careful when we use methods. There are many informal
checks.

---

### Easy Checks

1. Run separately across batches
1. Run with different hyperparameters

---

### Difficult (but Useful) Checks

1. Run a simulation experiment
1. It is getting easier to run your own benchmarks.
1. We always use positive and negative controls in wet lab experiments. Why not in computational analysis?

---

## Disciplined Design and Analysis

---

### Replication and controls

We often know a lot more about our data than we use in our methods. For example:

1. Replication

1. Controls

---

### CellAnova: Cheat Sheet

1. Use controls samples and genes to match across batches.

---

### CellAnova: Cheat Sheet

1. Any useful mathematical facts?

---

### Conclusion

1. Garbage In, Garbage Out: 

1. Essential Approaches:

1. Diagnostics: 

---

class: reference

### References

```{r, results='asis', echo = FALSE}
PrintBibliography(bib, start = 1, end = 13)
```

---

class: reference

### References

```{r, results='asis', echo = FALSE}
PrintBibliography(bib, start = 14, end = 29)
```

---



---

### Figure Attributions